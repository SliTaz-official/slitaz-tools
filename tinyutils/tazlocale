#!/bin/sh
#
# Tazlocale: SliTaz GNU/Linux locale setting using dialog boxes.
# Configuration file is: /etc/locale.conf
#
# Copyright (C) 2008-2012 SliTaz GNU/Linux - BSD License
#
# Author: Christophe Lincoln <pankso@slitaz.org>
#
. /lib/libtaz.sh

# Internationalization
. /usr/bin/gettext.sh
TEXTDOMAIN='slitaz-tools'
export TEXTDOMAIN

# Create symlink to translated files provided by SliTaz language pack,
# doc and config files.
link_language_files()
{
	. /etc/locale.conf
	LANGUAGE=${LANG%_*}
	[ "$LANG" = "POSIX" ] && LANGUAGE="en"
	# Openbox menu in /usr/share/doc/slitaz
	if [ -f /etc/xdg/openbox/menu.$LANGUAGE.xml ]; then
		cd /etc/xdg/openbox && rm -f menu.xml
		ln -s menu.$LANGUAGE.xml menu.xml
	fi
	# Documentation in /usr/share/doc/slitaz
	if [ -f /usr/share/doc/slitaz/index.$LANGUAGE.html ]; then
		cd /usr/share/doc/slitaz && rm -f index.html
		ln -s index.$LANGUAGE.html index.html
	fi
	# SliTaz Software Manuals
	for soft in tazpkg tazlito tazusb tazwok tazweb cookutils 
	do
		if [ -f /usr/share/doc/$soft/$soft.$LANGUAGE.html ]; then
			cd /usr/share/doc/$soft && rm -f $soft.html
			ln -s $soft.$LANGUAGE.html $soft.html
		fi
	done
	# SliTaz TazWeb "My Web Home"
	if [ -f /usr/share/tazweb/home.$LANGUAGE.html ]; then
		cd /usr/share/tazweb && rm -f home.html
		ln -s home.$LANGUAGE.html home.html
	fi
	# SliTaz WebHome
	if [ -f /usr/share/webhome/index.$LANGUAGE.html ]; then
		cd /usr/share/webhome && rm -f index.html
		ln -s index.$LANGUAGE.html index.html
	fi
    # TazPanel Doc under www
    if [ -f /var/www/tazpanel/doc/tazpanel.$LANGUAGE.html ]; then
        cd /var/www/tazpanel/doc && rm -f tazpanel.html
        ln -s tazpanel.$LANGUAGE.html tazpanel.html
    fi
	# SliTaz Tools Manuals
	for soft in tazinst
	do
		if [ -f /usr/share/doc/slitaz/$soft.$LANGUAGE.html ]; then
			cd /usr/share/doc/slitaz && rm -f $soft.html
			ln -s $soft.$LANGUAGE.html $soft.html
		fi
	done
}

# Locale name displayed.
get_locale_name()
{
	for i in $(ls -1 /usr/share/i18n/locales | grep ^[a-z][a-z]_[A-Z][A-Z])
	do
		#desc=$(grep ^title /usr/share/i18n/locales/$i | cut -d '"' -f 2)
		echo "$i Locale"
	done
}

# We have no locale files in /usr/lib/locale by default. Run localedef in
# background to have a faster boot.
gen_utf8_locale()
{
	localedef -i $locale -c -f UTF-8 /usr/lib/locale/$locale &
}

# Config /etc/locale.conf
system_config() {
	export LC_ALL=$locale
	gettext "Setting system locale to:"; echo -n " $locale"
	echo "LANG=$locale" > /etc/locale.conf
	echo "LC_ALL=$locale" >> /etc/locale.conf
	# Resource libtaz.sh to get status message in the correct locale.
	. /lib/libtaz.sh && status
	gen_utf8_locale
	link_language_files
}

# Dialog menu.
dialog_menu()
{
	exec 3>&1
	locale=$($DIALOG  --clear \
	--title " $(gettext "SliTaz language configuration") " \
	--menu "" 15 70 5 \
"en" "English" \
$(get_locale_name) \
2>&1 1>&3)
	retval=$?
	exec 3>&-
	case $retval in
		0) continue ;;
		1|255) exit 0 ;;
	esac

	# Default: POSIX = English
	[ "$locale" = "en" ] && locale="en_US"
	[ -s /etc/locale.conf ] && RECONFIG="yes"

	# If it's a reconfiguration give an info message.
	if [ -n "$RECONFIG" ]; then
		export LC_ALL=$locale
		msg=$(gettext "\
Please logout of your current session and login again to use new locale.")
		$DIALOG --clear --title " Information " --msgbox "$msg" 16 70
	fi
	system_config
}

case "$1" in
	info)
		gettext "Config file   :"; echo " /etc/locale.conf"
		gettext "Current locale:"; echo " $LANG" ;;
	list)
		for i in $(ls -1 /usr/share/i18n/locales | grep ^[a-z][a-z]_[A-Z][A-Z])
		do
			desc=$(grep ^title /usr/share/i18n/locales/$i | cut -d '"' -f 2)
			echo "$i $desc"
		done ;;
	"")
		# No args: display Ncurses dialog.
		: ${DIALOG=dialog}
		check_root
		dialog_menu ;;
	*)
		# Usage: tazlocale LANG_COUNTRY
		locale=$1
		check_root
		system_config
		gen_utf8_locale
		link_language_files ;;
esac

exit 0
