#!/bin/sh
#
# Tazx - Ncurses startx script for SliTaz GNU/Linux using Dialog boxes.
# This tinyutils is part of slitaz-tools.
#
# 20080114 <pankso@slitaz.org> - GNU gpl v3.
#
: ${DIALOG=dialog}

# Variables.
XSERVER=Xvesa
DOC=/usr/share/doc/slitaz-tools/tazx.txt
MOUSE=/dev/input/mice,5
WM=jwm

exec 3>&1
value=`$DIALOG --help-button \
    --clear \
    --title " Start X on SliTaz " \
    --menu \
"L'application 'tazx' vous permet configurer votre session X \
sur votre système GNU/Linux. Syntaxe : \
Ecran largeur x hauteur x nb-couleurs" 15 70 5 \
"640x480x16" "TrueColor" \
"640x480x24" "TrueColor" \
"800x600x16" "TrueColor" \
"800x600x24" "TrueColor" \
"1024x768x16" "TrueColor" \
"1024x768x24" "TrueColor" \
"1280x1024x16" "TrueColor" \
"1280x1024x24" "TrueColor" \
"1600x1200x16" "TrueColor" \
"1600x1200x24" "TrueColor" \
"1920x1440x16" "TrueColor" \
"xterm" "800x600x16" \
"quit" "Quitter" \
2>&1 1>&3`
retval=$?
exec 3>&-

case $retval in
  0)
    continue ;;
  1)
    echo "Cancel pressed..."
    exit 0 ;;
  2)
    $DIALOG --clear \
      --title " Aide - Help " \
      --textbox "$DOC" 15 70
      exec tazx ;;
  255)
    if test -n "$value"; then
      echo "$value"
    else
      echo "ESC pressed..."
      exit 0
    fi ;;
esac

# Set selected value.
case $value in
	xterm)
		Xvesa -ac -shadow -screen 1024x768x24 -br &
		exec xterm -cr green -geometry 80x35+0-0 ;;
	*)
		SCREEN=$value ;;
esac

# Copy a JWM system config if any in present in user home
# and change backgroud image if the 3/4 is not respected.
if [ ! -f "$HOME/.jwmrc" ] ; then
    cp /etc/jwm/system.jwmrc $HOME/.jwmrc
fi
if [ "$SCREEN" = "1280x1024x[0-9]" ] ; then
    sed -i s/'1024x768.png'/'1280x1024.png'/ $HOME/.jwmrc
fi
if [ "$SCREEN" = "1024x768x[0-9]" ] ; then
    sed -i s/'1280x1024.png'/'1024x768.png'/ $HOME/.jwmrc
fi

# Creat ~/.xsession to keep the configuration selected.
#
cat > $HOME/.xsession << EOT
# ~/.xsession: Start X window session on your system.
#
$XSERVER -ac -shadow -screen $SCREEN -mouse $MOUSE &
sleep 1 &
#xterm -bg khaki3 -fg white -cr orange -geometry 80x15+20+20 &
#xpad &
#mpg123 sound.wav &
exec $WM
EOT

chmod 700 $HOME/.xsession

# End messages.
echo "Configuration réussie."
echo "Screen : $SCREEN"

exit 0
